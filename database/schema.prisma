// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id          String   @id @default(cuid())
  externalId  String?  @unique @map("external_id")
  email       String   @unique
  name        String?
  department  String?
  status      String   @default("ACTIVE")
  preferences String?  // JSON as string
  lastLogin   DateTime? @map("last_login")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  roles       UserRole[]
  auditLogs   AuditLog[]

  @@map("users")
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  users       UserRole[]
  permissions ApplicationPermission[]

  @@map("roles")
}

model UserRole {
  id     String @id @default(cuid())
  userId String @map("user_id")
  roleId String @map("role_id")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@map("user_roles")
}

model Application {
  id          String   @id @default(cuid())
  name        String
  code        String   @unique
  description String?
  category    String   @default("OPERATIONS")
  url         String?
  environment String   @default("PRODUCTION")
  isActive    Boolean  @default(true) @map("is_active")
  ssoConfig   String?  @map("sso_config") // JSON as string
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  permissions ApplicationPermission[]

  @@map("applications")
}

model ApplicationPermission {
  id              String @id @default(cuid())
  applicationId   String @map("application_id")
  roleId          String @map("role_id")
  permissionLevel String @default("VIEW")

  // Relations
  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  role        Role        @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([applicationId, roleId])
  @@map("application_permissions")
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?  @map("user_id")
  eventType  String   @map("event_type")
  resourceId String?  @map("resource_id")
  details    String   // JSON as string
  ipAddress  String   @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("audit_logs")
}

// File processing models (simplified for SQLite)
model FileUpload {
  id           String   @id @default(cuid())
  filename     String
  originalName String   @map("original_name")
  mimeType     String   @map("mime_type")
  size         Int
  storageType  String   @map("storage_type")
  storagePath  String   @map("storage_path")
  status       String   @default("READY")
  uploadedBy   String   @map("uploaded_by")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("file_uploads")
}

model ProcessingJob {
  id               String    @id @default(cuid())
  type             String
  status           String    @default("PENDING")
  inputFileId      String?   @map("input_file_id")
  outputFileId     String?   @map("output_file_id")
  startedAt        DateTime? @map("started_at")
  completedAt      DateTime? @map("completed_at")
  errorLog         String?   @map("error_log")
  processingConfig String?   @map("processing_config") // JSON as string
  createdBy        String    @map("created_by")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  @@map("processing_jobs")
}